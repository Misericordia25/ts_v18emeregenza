<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impostazioni app Misericordia</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4faff;
  margin:0; padding:20px;
  max-width:720px;
  margin:auto;
}
h1{margin-bottom:10px;color:#0056b3;}
.section{
  background:#fff;
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
  border:2px solid #d9e7ff;
}
label{font-weight:bold;margin-top:10px;display:block;}
input,textarea{
  width:100%;
  padding:10px;
  margin-top:5px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:16px;
}
button{
  padding:12px 22px;
  margin:8px 4px;
  font-size:17px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#0069d9;
  color:#fff;
}
.btn-secondary{background:#28a745!important;}
.btn-warning{background:#ff9f00!important;}
.btn-danger{background:#dc3545!important;}
.hidden{display:none}
</style>
</head>

<body>

<h1>‚öôÔ∏è Impostazioni App Misericordia</h1>

<!-- ==========================
     BLOCCO PRESIDENTE
=========================== -->
<div id="admin_section" class="hidden">

  <!-- üîπ INIZIALIZZAZIONE TABLET -->
  <div class="section">
    <h3>üè∑Ô∏è Inizializzazione Tablet (Societ√†)</h3>

    <label>Codice Societ√†</label>
    <input id="codice_societa" type="text" placeholder="Es. MIS_OSIMO">

    <button class="btn-secondary" onclick="inizializzaTablet()">
      üîÑ Carica configurazione societ√†
    </button>

    <div id="init_status" style="margin-top:8px;font-weight:bold;"></div>
  </div>

  <!-- DATI ENTE -->
  <div class="section">
    <h3>üèõÔ∏è DATI ENTE</h3>
    <label>Nome ente</label>
    <input id="ente_nome" type="text">
    <label>Citt√†</label>
    <input id="ente_citta" type="text">
    <label>Via</label>
    <input id="ente_via" type="text">
    <label>Numero civico</label>
    <input id="ente_civico" type="text">
    <label>Telefono</label>
    <input id="ente_tel" type="text">
  </div>

  <!-- EMAIL -->
  <div class="section">
    <h3>üìß EMAIL DI INVIO DOCUMENTO TS</h3>
    <label>Email destinazione</label>
    <input id="mail_check" type="email">
    <label>Password Drive</label>
    <input id="mail_pwd" type="password">
  </div>

  <!-- SICUREZZA -->
  <div class="section">
    <h3>üîê Sicurezza</h3>
    <button class="btn-danger" onclick="cambiaPin()">üîÑ Cambia PIN Presidente</button>
  </div>

  <!-- IMPORT / EXPORT -->
  <div class="section">
    <h3>üîí Import / Export impostazioni</h3>
    <textarea id="jsonArea" rows="4"></textarea>
    <button class="btn-secondary" onclick="copyJSON()">Copia JSON</button>
    <button class="btn-warning" onclick="importJSON()">Importa JSON</button>
  </div>

  <button onclick="saveSettings()" class="btn-secondary">üíæ Salva impostazioni</button>
</div>

<!-- ==========================
     BLOCCO OPERATORE
=========================== -->
<div id="operator_section" class="section">
  <h3>üöë Accesso Operatore</h3>
  <p>Inserire la targa del veicolo dalla schermata principale.</p>
  <button onclick="sbloccaAdmin()">‚öôÔ∏è Accesso Presidente</button>
</div>

<button onclick="location.href='index.html'" class="btn-warning">üè† Torna alla Pagina Ponte</button>

<!-- LOAD CONFIG -->
<script src="js/load-config.js"></script>

<script>
const LS_KEY_PLAIN  = "IMPOSTAZIONI_MISERICORDIA";
const LS_KEY_SECURE = "IMPOSTAZIONI_MISERICORDIA_SECURE";
const PIN_KEY       = "PIN_PRESIDENTE";
const ADMIN_UNLOCK  = "ADMIN_UNLOCKED";

/* ==========================
   SBLOCCO PRESIDENTE
=========================== */
function sbloccaAdmin(){
  const pin = prompt("Inserisci codice presidente");
  if(!pin) return;

  let saved = localStorage.getItem(PIN_KEY);
  if(!saved){
    localStorage.setItem(PIN_KEY, pin);
    saved = pin;
    alert("PIN presidente impostato");
  }

  if(pin === saved){
    localStorage.setItem(ADMIN_UNLOCK, "1");
    mostraAdmin();
  }else{
    alert("Codice errato");
  }
}

function mostraAdmin(){
  admin_section.classList.remove("hidden");
  operator_section.classList.add("hidden");
}

/* ==========================
   INIZIALIZZAZIONE TABLET
=========================== */
async function inizializzaTablet(){
  const codice = codice_societa.value.trim().toUpperCase();
  const status = document.getElementById("init_status");

  if(!codice){
    status.textContent = "‚ùå Inserire un codice societ√†";
    status.style.color = "red";
    return;
  }

  localStorage.setItem("CODICE_SOCIETA", codice);
  status.textContent = "‚è≥ Caricamento configurazione...";
  status.style.color = "#555";

  const ok = await loadConfigurazioneSocieta();

  if(ok){
    status.textContent = "‚úÖ Configurazione caricata";
    status.style.color = "green";
    location.reload();
  }else{
    status.textContent = "‚ùå Errore caricamento configurazione";
    status.style.color = "red";
  }
}

/* ==========================
   CAMBIO PIN
=========================== */
function cambiaPin(){
  const oldPin = prompt("Inserisci PIN attuale");
  if(oldPin !== localStorage.getItem(PIN_KEY)){
    alert("PIN errato");
    return;
  }
  const newPin = prompt("Nuovo PIN (min 4 cifre)");
  if(!newPin || newPin.length < 4){
    alert("PIN non valido");
    return;
  }
  localStorage.setItem(PIN_KEY, newPin);
  alert("PIN aggiornato");
}

/* ==========================
   CARICAMENTO DATI
=========================== */
window.onload = () => {

  // üîπ mostra codice societ√† se gi√† inizializzato
  const cs = localStorage.getItem("CODICE_SOCIETA");
  if(cs) codice_societa.value = cs;

  if(localStorage.getItem(ADMIN_UNLOCK)==="1") mostraAdmin();

  const raw = localStorage.getItem(LS_KEY_PLAIN);
  if(raw){
    try{
      const cfg = JSON.parse(raw);
      ente_nome.value  = cfg.ente.nome || "";
      ente_citta.value = cfg.ente.citta || "";
      ente_via.value   = cfg.ente.via || "";
      ente_civico.value= cfg.ente.civico || "";
      ente_tel.value   = cfg.ente.tel || "";
      mail_check.value = cfg.mail?.to || "";
      mail_pwd.value   = cfg.mail?.pwd || "";
    }catch(e){}
  }
};

/* ==========================
   SALVATAGGIO
=========================== */
async function saveSettings(){
  const pin = prompt("Conferma PIN presidente");
  if(pin !== localStorage.getItem(PIN_KEY)){
    alert("PIN non valido");
    return;
  }

  const settings = {
    ente:{
      nome: ente_nome.value,
      citta: ente_citta.value,
      via: ente_via.value,
      civico: ente_civico.value,
      tel: ente_tel.value
    },
    mail:{
      to: mail_check.value,
      pwd: mail_pwd.value
    }
  };

  localStorage.setItem(LS_KEY_PLAIN, JSON.stringify(settings));

  const encrypted = await encrypt(pin, settings);
  localStorage.setItem(LS_KEY_SECURE, JSON.stringify(encrypted));

  alert("Impostazioni salvate");
}

/* ==========================
   CIFRATURA
=========================== */
function bufToBase64(bytes){ let s=""; bytes.forEach(b=>s+=String.fromCharCode(b)); return btoa(s);}
async function deriveKey(pin, salt){
  const keyMaterial = await crypto.subtle.importKey("raw", new TextEncoder().encode(pin), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:50000,hash:"SHA-256"},
    keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function encrypt(pin, obj){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const key  = await deriveKey(pin, salt);
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const enc  = await crypto.subtle.encrypt({name:"AES-GCM",iv}, key, data);
  return {salt:bufToBase64(salt),iv:bufToBase64(iv),data:bufToBase64(new Uint8Array(enc))};
}
function copyJSON(){
  const raw = localStorage.getItem(LS_KEY_SECURE);
  if(raw) navigator.clipboard.writeText(raw);
}
function importJSON(){
  try{
    localStorage.setItem(LS_KEY_SECURE, jsonArea.value);
    alert("Importato");
  }catch{}
}
</script>

</body>
</html>
